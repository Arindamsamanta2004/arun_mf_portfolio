<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Arun Bikash Samanta</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@500;600;700&display=swap"
        rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

    <!-- Navbar -->
    <header>
        <div class="container">
            <nav>
                <a href="index.html" class="logo">
                    <img src="assets/images/logo.png" alt="Arun Bikash Samanta">
                </a>
                <ul class="nav-links">
                    <li><a href="index.html#home">Home</a></li>
                    <li><a href="#" id="logoutBtn" style="color: red;">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Admin Section -->
    <section class="admin-section section-padding" style="padding-top: 150px; min-height: 80vh;">
        <div class="container">
            <div class="section-title">
                <h2>Admin Dashboard</h2>
                <div class="title-underline"></div>
                <p>View and manage contact requests.</p>
            </div>

            <!-- Loading State -->
            <div id="loading" style="text-align: center; font-size: 1.2rem;">Loading data...</div>

            <!-- Error State -->
            <div id="errorMsg" style="text-align: center; color: red; display: none;"></div>

            <!-- Data Table -->
            <div class="table-responsive" id="contactsTableWrapper" style="display: none;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Message</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- APPOINTMENTS SECTION -->
            <div class="section-title" style="margin-top: 50px;">
                <h2>Appointments</h2>
                <div class="title-underline"></div>
            </div>

            <!-- Loading State -->
            <div id="loadingAppts" style="text-align: center; font-size: 1.2rem;">Loading appointments...</div>

            <div class="table-responsive" id="apptsTableWrapper" style="display: none;">
                <table class="admin-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>User ID</th>
                            <th>Reason</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="apptsTableBody">
                        <!-- Data will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- Scripts -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        // Inline script to fetch data immediately if auth is valid
        document.addEventListener('DOMContentLoaded', async () => {
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // Check session
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }

            // Verify Admin Role
            const { data: profile, error: profileError } = await supabase
                .from('profiles')
                .select('role')
                .eq('id', session.user.id)
                .single();

            if (profileError || !profile || profile.role !== 'admin') {
                // Not an admin - redirect to home
                alert('Access Denied: You are not an administrator.');
                window.location.href = 'index.html';
                return;
            }

            // Fetch Contacts Data
            try {
                const { data, error } = await supabase
                    .from('contacts')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('contactsTableBody');
                if (data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No messages found.</td></tr>';
                } else {
                    tbody.innerHTML = data.map(contact => `
                        <tr>
                            <td>${new Date(contact.created_at).toLocaleDateString()}</td>
                            <td>${contact.name}</td>
                            <td>${contact.email}</td>
                            <td>${contact.phone}</td>
                            <td>${contact.message || '-'}</td>
                        </tr>
                    `).join('');
                }

                document.getElementById('loading').style.display = 'none';
                document.getElementById('contactsTableWrapper').style.display = 'block';

            } catch (err) {
                console.error('Error fetching contacts:', err);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('errorMsg').innerText = 'Failed to load contacts.';
                document.getElementById('errorMsg').style.display = 'block';
            }

            // Fetch Appointments Data
            try {
                const { data, error } = await supabase
                    .from('appointments')
                    .select('*')
                    .order('appointment_date', { ascending: true }); // Newest first by date

                if (error) throw error;

                const apptBody = document.getElementById('apptsTableBody');
                if (data.length === 0) {
                    apptBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">No appointments found.</td></tr>';
                } else {
                    apptBody.innerHTML = data.map(appt => `
                        <tr>
                            <td>${new Date(appt.appointment_date).toLocaleDateString()}</td>
                            <td>${appt.appointment_time}</td>
                            <td>${appt.user_id}</td>
                            <td>${appt.reason}</td>
                            <td><span class="status-badge ${appt.status}">${appt.status}</span></td>
                        </tr>
                    `).join('');
                }

                document.getElementById('loadingAppts').style.display = 'none';
                document.getElementById('apptsTableWrapper').style.display = 'block';

            } catch (err) {
                console.error('Error fetching appointments:', err);
                document.getElementById('loadingAppts').style.display = 'none';
            }
        });
    </script>
</body>

</html>